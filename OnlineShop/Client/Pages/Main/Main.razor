@page "/Main";
@layout MainLayout;
@using OnlineShop.Shared
@using OnlineShop.Client.Pages.Auth
@inject HttpClient client
@inject ISnackbar Snackbar
@inject IDialogService Dialog

<MudContainer>
    @* <MudButton Color="Color.Dark" @onclick="OpenLoginDialog">Normal Snackbar</MudButton> *@
    @if (goodsStats == null)
    {
        <MudProgressCircular Color="Color.Default" Indeterminate="true" />
    }
    else if (goodsStats != null)
    {
        @for (int i = 0; i < goodsStats.Length; i++)
        {
            <GoodItem ID=@goodsStats[i].ID Name=@goodsStats[i].Name Price=@goodsStats[i].Price OnBuyGood="BuyGoods"/>
        }
    }
</MudContainer>

@code {
    //private Dictionary<string, string> buttonStrings;
    private GoodsStats[] goodsStats;
    private string test;

    //Спавн, значения и прочее для модалки с логином
    private string username;
    private string password;
    

    public async Task BuyGoods(int goodsID)
    {
        var response = await client.PostAsJsonAsync<int>("api/Catalog", goodsID);
        ResponseStatus result = await response.Content.ReadFromJsonAsync<ResponseStatus>();

        switch (result)
        {
            case ResponseStatus.Completed:
                Snackbar.Clear();
                Snackbar.Add("Успешно куплено", Severity.Success);
                break;
            case ResponseStatus.Failed:
                Snackbar.Clear();
                Snackbar.Add("Произошла ошибка при покупке", Severity.Error);
                break;
            case ResponseStatus.NotAuthorized:
                await OpenLoginDialog();
                break;
            default:
                break;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
        try
        {
            goodsStats = await client.GetFromJsonAsync<GoodsStats[]>("api/Catalog");
        }
        catch
        {
        }
    }

    private async Task OpenLoginDialog()
    {
        Dialog.Show<AuthDialog>();
    // StateHasChanged();
    }
}